---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->
```{r echo=FALSE}
library(htmltools)
knitr::opts_chunk$set(
  fig.align = "center"
)
knitr::knit_hooks$set(imgcenter = function(before, options, envir){
  if (before) {
    HTML("<p align='center'>")
  } else {
    HTML("</p>")
  }
})
```    
 

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-", fig.align='center')
```
# EMtree

> EMtree infers interaction networks from abundance data. It uses averages over spanning trees within a Poisson log-Normal Model ([PLNmodels](https://github.com/jchiquet/PLNmodels>)), and involves plotting funcitonalities (using `ggraph` and `tydigraph`).

## Installation

You can install the development version of EMtree:

``` r
devtools::install_github("Rmomal/EMtree")
```

## Example with Fatala river fishes

This is a basic example which shows you how to infer a network, using Barans95 data from the `ade4` package.

### Data


```{r fish_data , message=FALSE}
library(ade4)
library(tidyverse)
data(baran95)
counts = as.matrix(baran95$fau)
covar = as_tibble(baran95$plan)

n = nrow(counts)
p = ncol(counts)
```
```{r}
head(counts)
head(covar)
```

### Fit PLN model
This creates a `PLNmodels` object
```{r}
library(PLNmodels)
model<-PLN(counts ~ covar$site)
```

### Run EMtree function

```{r output}
library(EMtree)
output<-EMtree(model,  maxIter = 5)
str(output)
```
### Foster robustness with resampling :


```{r, cache=TRUE}
library(parallel)
resample_output<-ResampleEMtree(counts, "covar$site", B=2, maxIter=2,cond.tol=1e-8, cores=1)
str(resample_output)
```

### Several models with resampling :


```{r, cache=TRUE}
library(parallel)
compare_output<-ComparEMtree(counts, c("covar$site","covar$date"), B=2, maxIter=2,cond.tol=1e-8, cores=1,
                             f=0.8,seed=1)
str(compare_output)
```
### Graphics
#### From `EMtree` output

Simple network:

```{r, fig.asp=1, fig.width=4, fig.fullwidth=FALSE}
library(ggraph)
library(tidygraph)
library(viridis)
seed<-200

x<- 1*(output$ProbaCond>2/p)
draw_network(x,"Site", pal="dodgerblue3")

```

#### From `ResampleEMtree` output

```{r, fig.height=4, fig.width=4, imgcenter = TRUE}
f<-0.8
df<-freq_selec(resample_output$Pmat,p=p,f=f)
draw_network(df,"Site")

```

#### Facet for plotting several models in one shot

```{r, fig.height=3.5, fig.width=10,imgcenter = TRUE}
compar_graphs(compare_output,alpha=TRUE)
```

